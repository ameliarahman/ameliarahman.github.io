---
layout: post
title: "Fundamental of Database - Part 5 : PgBench"
description: "What is pgbench and how to use it in postgresql"
date: 2025-01-24 10:00:00
comments: true
keywords: "Database, Postgres, Query, pgbench, testing, stress test, load test"
category: [Tech]
tags:
- database, postgresql, sql, test, pgbench, load test
---


I was curious about how to test and analyze my database, especially the performance of my queries, under the load of concurrent users accessing the database at specific times. If the goal is just to test the execution time of queries and improve performance, we can seed the database with many rows then observe which queries become slower. But what if a query is being accessed simultaneously by many users at once? How can we simulate such a scenario? After researching, I discovered that PostgreSQL includes a tool for this purpose: pgbench.

As stated from <a href="https://www.postgresql.org/docs/current/pgbench.html" target="_top"> PosgreSQL Documentation</a>:

>pgbench is a simple program for running benchmark tests on PostgreSQL. It runs the same sequence of SQL commands over and over, possibly in multiple concurrent database sessions, and then calculates the average transaction rate (transactions per second). By default, pgbench tests a scenario that is loosely based on TPC-B, involving five SELECT, UPDATE, and INSERT commands per transaction. However, it is easy to test other cases by writing your own transaction script files.

As what I get from asking GPT:
>TPC-B, Transaction Processing Performance Council Benchmark is a benchmark used to evaluate the performance of transaction processing systems, like the number of transactions per second that can be processed. Specifically, it's a test designed to simulate the performance of a database system under heavy transaction load.

Let's jump into practice.

First thing first, here's my docker compose to start:
<script src="https://gist.github.com/ameliarahman/18ca7ec9a3169b83f16f6c7df6183100.js"></script>

Go inside the container:
```
docker exec -it postgres_pgbench bash
```

We can make sure that pgbench is automatically included by running this command:
```
which pgbench
```

### Initialization
Now, let's initiate the pgbench:
```
pgbench -i [ other-options ] dbname
```
Since I already have the database under the name `db` with the user `user`, the full command is below:

```
pgbench -i db -U user
```
- -i means initialization, this command creates 4 default tables to test: 
`pgbench_accounts, pgbench_branches,pgbench_history, and pgbench_tellers`, and drop any existing tables of these names.
- By default, this will contain specific rows for each table in scale factor `1`:

    Table            |     Rows
    -----------------|----------------
    pgbench_branches |  1
    pgbench_tellers  |  10
    pgbench_accounts |  100000
    pgbench_history  |  0
    
    We can insert more rows by simply adding `-s `(scale factor) option.

And here is the result if I try to execute the command with `-s` option:

```
pgbench -i db -s 100 -U user
```
![](../assets/img/pgbench/pgbench1.png)

The created tables:
![](../assets/img/pgbench/pgbench2.png)

And how many rows created when scaling up to 100:
![](../assets/img/pgbench/pgbench3.png)


### Benchmarking
After the initialization, then what can we do to benchmark our database performance? After reading postgres documentation, asking Chat GPT, and also other resources. Here's the example command that we can execute to run scenario of load test the performance (of course there are still many options that we can use referring to official documentation):

```
pgbench -U <user> -d <database> -T <duration_in_seconds> -c <number_of_clients> -j <number_of_threads> -P <number_of_second>
```
- -U: User of database
- -d: The name of database
- -T: Duration in seconds to execute the test
- -c: Simulation number of concurrent clients that access our database. The default is 1.
- -j: Number of worker threads.
- -P: Show progress report every certain seconds/

Let's see what will happen after executing the command:
```
pgbench -U user -d db -T 200 -c 100 -j 5 -P 5
```
 
And here is the result:
![](../assets/img/pgbench/pgbench4.png)

Let's break down one by one:
- The first line means the pgbench is starting `vacuum` to clean up dead rows and optimize the database during the benchmark. <a href="https://www.postgresql.org/docs/current/sql-vacuum.html" target="_top"> Read more about vacuum in postgresql</a>.
- The `progress` line indicates the benchmark situation every 5 seconds.
- Transaction type, as stated above that the `pgbench tests a scenario that is loosely based on TPC-B, involving five SELECT, UPDATE, and INSERT commands per transaction`
- Scaling factor that I already set up to 100

